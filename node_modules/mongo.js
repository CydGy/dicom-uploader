var MongoClient = require('mongodb').MongoClient;


exports.dicomup = mongoConnection(
  '127.0.0.1',
  27017,
  'dicomup',
  ['images']
);


function mongoConnection (host, port, dbName, collectionNames) {

	var databases = {};
	
	return function (callback) {
		
		if (databases[dbName]) return callback(null, databases[dbName]);
		
		MongoClient.connect('mongodb://' + host + ':' + port + '/' + dbName,
    function (err, db) {
			if (err) return callback(err);

      databases[dbName] = {};

			db.on('close', function () {
				delete databases[dbName];
			});

      for (var i = 0; i < collectionNames.length; i++) {
        databases[dbName][collectionNames[i]] = db.collection(
          collectionNames[i]);
      }

      callback(null, databases[dbName]);

		});
			
	};

}
